name: "build and Test"

on: ["push", "pull_request"]

jobs:
    TestOnMacOS-11_0-x86_64:
        runs-on: "macos-11"
        steps:
            - uses: "actions/checkout@v2"
            - name: "Install Dependencies"
              run: "brew install qt@5"
            - name: "Build Project"
              run: "swift build"
    TestOnUbuntu-20_04-x86_64:
        runs-on: "ubuntu-latest"
        steps:
            - uses: "actions/checkout@v2"
            - name: "Install Dependencies"
              run: |
                sudo apt update
                sudo apt install -yq libqt5gui5 libqt5quick5 qtdeclarative5-dev libqt5quickwidgets5 qtquickcontrols2-5-dev qtbase5-dev
            - name: "Build Project"
              run: |
                export PKG_CONFIG_PATH="/usr/lib/x86_64-linux-gnu/pkgconfig/"
                swift build
    TestOnWindows10-x86_64:
        runs-on: "windows-latest"
        steps:
            - uses: "actions/checkout@v2"
            - uses: "seanmiddleditch/gha-setup-vsdevenv@master"
            - name: "Install swift-5.5.1-RELEASE"
              run: |
                  Install-Binary -Url "https://download.swift.org/swift-5.5.1-release/windows10/swift-5.5.1-RELEASE/swift-5.5.1-RELEASE-windows10.exe" -Name "installer.exe" -ArgumentList ("-q")
            - name: "Set Environment Variables"
              run: |
                  echo "SDKROOT=C:\Library\Developer\Platforms\Windows.platform\Developer\SDKs\Windows.sdk" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
                  echo "DEVELOPER_DIR=C:\Library\Developer" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            - name: "Adjust Paths"
              run: echo "C:\Library\Developer\Toolchains\unknown-Asserts-development.xctoolchain\usr\bin;C:\Library\Swift-development\bin;C:\Library\icu-67\usr\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            - name: "Install Supporting Files"
              shell: "cmd"
              run: |
                  copy "%SDKROOT%\usr\share\ucrt.modulemap" "%UniversalCRTSdkDir%\Include\%UCRTVersion%\ucrt\module.modulemap"
                  copy "%SDKROOT%\usr\share\visualc.modulemap" "%VCToolsInstallDir%\include\module.modulemap"
                  copy "%SDKROOT%\usr\share\visualc.apinotes" "%VCToolsInstallDir%\include\visualc.apinotes"
                  copy "%SDKROOT%\usr\share\winsdk.modulemap" "%UniversalCRTSdkDir%\Include\%UCRTVersion%\um\module.modulemap"
            - name: "Install QT"
              run: "choco install qt5-default"
            - name: "Build Project"
              run: "swift build"